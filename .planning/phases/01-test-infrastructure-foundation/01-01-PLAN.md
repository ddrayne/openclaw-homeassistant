---
phase: 01-test-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - tests/__init__.py
  - custom_components/__init__.py
autonomous: true

must_haves:
  truths:
    - "Tests can be run with `pytest` command"
    - "Coverage report appears after test run"
    - "pytest discovers tests in tests/ directory"
  artifacts:
    - path: "pyproject.toml"
      provides: "pytest configuration with asyncio mode"
      contains: "asyncio_mode"
    - path: "tests/__init__.py"
      provides: "Test package marker"
      min_lines: 1
    - path: "custom_components/__init__.py"
      provides: "Custom components package marker for test discovery"
      min_lines: 1
  key_links:
    - from: "pyproject.toml"
      to: "tests/"
      via: "testpaths configuration"
      pattern: 'testpaths.*tests'
---

<objective>
Create pytest configuration and test directory structure for the Clawd Home Assistant integration.

Purpose: Establish the foundation for all subsequent test phases - proper pytest configuration with asyncio mode, coverage reporting, and directory structure.
Output: pyproject.toml with complete test configuration, tests/ directory ready for fixtures and tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-infrastructure-foundation/01-RESEARCH.md

# Source files for understanding domain constants
@custom_components/clawd/const.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pyproject.toml with pytest configuration</name>
  <files>pyproject.toml</files>
  <action>
Create pyproject.toml with:

1. Project metadata section:
   - name: "clawd-homeassistant"
   - version: "0.1.0"
   - requires-python: ">=3.11"

2. Optional dependencies for testing:
   - pytest>=9.0.0
   - pytest-asyncio>=1.0.0
   - pytest-homeassistant-custom-component>=0.13.200 (compatible with Python 3.11+)
   - pytest-cov>=7.0.0
   - pytest-mock>=3.12.0

3. pytest.ini_options:
   - testpaths = ["tests"]
   - asyncio_mode = "auto"
   - asyncio_default_fixture_loop_scope = "function"
   - addopts with --strict-markers, -ra, --cov=custom_components/clawd, --cov-report=term-missing, --cov-report=html

4. coverage.run configuration:
   - source = ["custom_components/clawd"]
   - branch = true

5. coverage.report configuration:
   - exclude_lines for pragma: no cover, raise NotImplementedError, if TYPE_CHECKING:, if __name__ == .__main__.:
   - show_missing = true

6. coverage.html configuration:
   - directory = "htmlcov"

Use the exact pyproject.toml format from 01-RESEARCH.md as the template.
  </action>
  <verify>Run `python -c "import tomllib; tomllib.load(open('pyproject.toml', 'rb'))"` to validate TOML syntax</verify>
  <done>pyproject.toml exists with complete pytest and coverage configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create test directory structure</name>
  <files>tests/__init__.py, custom_components/__init__.py</files>
  <action>
Create the test directory structure:

1. Create tests/__init__.py with a docstring:
   """Tests for the Clawd Home Assistant integration."""

2. Create custom_components/__init__.py with a docstring (required for pytest discovery of custom components):
   """Custom components package."""

Both files need only a docstring - they're package markers for pytest discovery.
  </action>
  <verify>Run `ls tests/__init__.py custom_components/__init__.py` to confirm both files exist</verify>
  <done>tests/ and custom_components/ are valid Python packages</done>
</task>

</tasks>

<verification>
1. pyproject.toml exists and is valid TOML
2. tests/__init__.py exists
3. custom_components/__init__.py exists
4. Running `pip install -e ".[test]"` would install test dependencies (do not actually run - just verify pyproject.toml structure)
</verification>

<success_criteria>
- pyproject.toml has [tool.pytest.ini_options] with asyncio_mode = "auto"
- pyproject.toml has [project.optional-dependencies] test section
- tests/ directory exists as Python package
- custom_components/ is a Python package (required for HA test discovery)
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-infrastructure-foundation/01-01-SUMMARY.md`
</output>
