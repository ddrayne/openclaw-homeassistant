---
phase: 01-test-infrastructure-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "Fixture 'hass' is available to test functions"
    - "Fixture 'mock_config_entry' provides a MockConfigEntry for clawd domain"
    - "Fixture 'mock_websocket' provides an AsyncMock with send/recv/close"
    - "Fixture 'mock_websocket_connect' patches websockets.connect"
    - "Async fixtures cleanup without 'Event loop is closed' errors"
  artifacts:
    - path: "tests/conftest.py"
      provides: "All core test fixtures"
      exports: ["auto_enable_custom_integrations", "mock_config_entry", "mock_websocket", "mock_websocket_connect"]
      min_lines: 50
  key_links:
    - from: "tests/conftest.py"
      to: "pytest_homeassistant_custom_component"
      via: "import MockConfigEntry, enable_custom_integrations"
      pattern: "from pytest_homeassistant_custom_component"
    - from: "mock_websocket_connect fixture"
      to: "custom_components.clawd.gateway"
      via: "patch target"
      pattern: 'patch.*custom_components.clawd.gateway.websockets.connect'
---

<objective>
Create comprehensive test fixtures in conftest.py for testing the Clawd integration.

Purpose: Provide reusable fixtures for hass object, config entries, and WebSocket mocking that all subsequent test phases will use.
Output: tests/conftest.py with auto_enable_custom_integrations, mock_config_entry, mock_websocket, and mock_websocket_connect fixtures.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-test-infrastructure-foundation/01-RESEARCH.md
@.planning/phases/01-test-infrastructure-foundation/01-01-SUMMARY.md

# Source files for understanding what to mock
@custom_components/clawd/const.py
@custom_components/clawd/gateway.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conftest.py with all core fixtures</name>
  <files>tests/conftest.py</files>
  <action>
Create tests/conftest.py with the following fixtures:

1. **auto_enable_custom_integrations** (autouse=True):
   - Depends on `enable_custom_integrations` from pytest-homeassistant-custom-component
   - Simply yields to enable the fixture for all tests
   - Required for HA to discover custom_components/clawd

2. **mock_config_entry**:
   - Returns a MockConfigEntry with:
     - domain=DOMAIN (from custom_components.clawd.const)
     - unique_id="localhost:8765"
     - data with host, port, token, use_ssl, timeout, session_key matching const.py defaults
     - title="Clawd Gateway (localhost)"
   - Use factory pattern (returns new instance each call)

3. **mock_websocket**:
   - Returns an AsyncMock configured as WebSocket:
     - ws.send = AsyncMock()
     - ws.recv = AsyncMock()
     - ws.close = AsyncMock()
     - ws.__aenter__ = AsyncMock(return_value=ws)
     - ws.__aexit__ = AsyncMock(return_value=None)

4. **mock_websocket_connect**:
   - Patches "custom_components.clawd.gateway.websockets.connect"
   - Uses Generator return type annotation
   - Creates async generator that yields mock_websocket
   - Yields tuple of (mock_connect, mock_websocket) for test access
   - Context manager ensures patch cleanup

Import statements needed:
- asyncio
- collections.abc.Generator
- unittest.mock (AsyncMock, patch)
- pytest
- pytest_homeassistant_custom_component.common (MockConfigEntry)
- custom_components.clawd.const (DOMAIN)

Follow the exact patterns from 01-RESEARCH.md "Complete conftest.py Template" section.
  </action>
  <verify>Run `python -c "from tests.conftest import *"` to verify imports work (after installing test deps)</verify>
  <done>conftest.py contains all 4 fixtures with proper typing and cleanup patterns</done>
</task>

<task type="auto">
  <name>Task 2: Add async cleanup helper fixture</name>
  <files>tests/conftest.py</files>
  <action>
Add to conftest.py (append after existing fixtures):

1. **async_cleanup** fixture (function scope):
   - Async fixture that yields, then runs `await asyncio.sleep(0)` in teardown
   - Purpose: Give event loop a chance to process pending callbacks
   - Tests with async resources should depend on this fixture
   - Pattern: Prevents "Event loop is closed" errors by ensuring cleanup tasks run

Example implementation:
```python
@pytest.fixture
async def async_cleanup():
    """Ensure async cleanup tasks can run."""
    yield
    # Give event loop a chance to process pending callbacks
    await asyncio.sleep(0)
```

This fixture establishes the cleanup pattern (INFRA-04) that tests can depend on when they create async resources that need cleanup time.
  </action>
  <verify>Run `python -c "import ast; ast.parse(open('tests/conftest.py').read())"` to verify valid Python syntax</verify>
  <done>async_cleanup fixture added, establishing cleanup pattern for all async tests</done>
</task>

</tasks>

<verification>
1. conftest.py is valid Python (no syntax errors)
2. All 5 fixtures are defined: auto_enable_custom_integrations, mock_config_entry, mock_websocket, mock_websocket_connect, async_cleanup
3. Import statements are correct (will fully verify when running tests in Plan 03)
</verification>

<success_criteria>
- conftest.py exists in tests/
- auto_enable_custom_integrations has autouse=True
- mock_config_entry returns MockConfigEntry with domain="clawd"
- mock_websocket returns AsyncMock with send/recv/close
- mock_websocket_connect patches the correct import path
- async_cleanup fixture establishes cleanup pattern
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-infrastructure-foundation/01-02-SUMMARY.md`
</output>
